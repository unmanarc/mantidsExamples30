<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Board</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        .thread-item {
            transition: background-color 0.3s;
        }
        .thread-item:hover {
            background-color: #f8f9fa;
        }
        .message-item {
            border-left: 3px solid #007bff;
        }
        .pinned-thread {
            background-color: #fff3cd;
        }
        .locked-thread {
            background-color: #f8d7da;
        }
        .edited-message {
            font-style: italic;
            color: #6c757d;
            font-size: 0.85em;
        }
        .message-metadata {
            font-size: 0.85em;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="loadThreads(); return false;">
                <i class="bi bi-chat-square-dots"></i> Message Board
            </a>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container mt-4">
        <!-- Thread List View -->
        <div id="threadListView">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Discussion Threads</h2>
                <button class="btn btn-success" onclick="showCreateThreadModal()">
                    <i class="bi bi-plus-circle"></i> New Thread
                </button>
            </div>
            
            <div id="threadsContainer">
                <!-- Threads will be loaded here -->
            </div>
        </div>

        <!-- Message View -->
        <div id="messageView" style="display: none;">
            <button class="btn btn-secondary mb-3" onclick="backToThreads()">
                <i class="bi bi-arrow-left"></i> Back to Threads
            </button>
            
            <div id="threadHeader" class="mb-4">
                <!-- Thread title and controls will be loaded here -->
            </div>
            
            <div id="messagesContainer" class="mb-4">
                <!-- Messages will be loaded here -->
            </div>
            
            <div id="messageFormContainer">
                <!-- Message form will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Create Thread Modal -->
    <div class="modal fade" id="createThreadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Thread</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newThreadTitle" class="form-label">Thread Title</label>
                        <input type="text" class="form-control" id="newThreadTitle" 
                               placeholder="Enter thread title" maxlength="255">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createThread()">Create Thread</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Message Modal -->
    <div class="modal fade" id="editMessageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editMessageContent" class="form-label">Message Content</label>
                        <textarea class="form-control" id="editMessageContent" rows="4"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedMessage()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentThreadId = null;
        let currentMessageId = null;
        let currentUser = null; // You'll need to get this from your auth system

        // Initialize on page load
        $(document).ready(function() {
            loadThreads();
        });

        // Common error handler
        function commonFunctionError(xhr, textStatus, errorThrown) {
            console.error('Error:', xhr.responseJSON || errorThrown);
            let errorMessage = 'An error occurred';
            
            if (xhr.responseJSON) {
                errorMessage = xhr.responseJSON.error || xhr.responseJSON.message || errorMessage;
            }
            
            alert('Error: ' + errorMessage);
        }

        // Load all threads
        function loadThreads() {
            document.getElementById('threadsContainer').innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
            
            $.ajax({
                url: '/api/v1/threads',
                type: 'GET',
                contentType: 'application/json',
                success: function(response) {
                    displayThreads(response);
                },
                error: commonFunctionError
            });
        }

        // Display threads
        function displayThreads(threads) {
            $('#threadsContainer').empty();
            
            if (!threads || threads.length === 0) {
                $('#threadsContainer').html('<div class="alert alert-info">No threads found. Create one to get started!</div>');
                return;
            }

            threads.forEach(function(thread) {
                let threadClass = 'thread-item card mb-3';
                if (thread.isPinned) threadClass += ' pinned-thread';
                if (thread.isLocked) threadClass += ' locked-thread';
                
                let threadHtml = `
                    <div class="${threadClass}" onclick="loadMessages(${thread.threadId})" style="cursor: pointer;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title" id="thread-title-${thread.threadId}">
                                        ${thread.isPinned ? '<i class="bi bi-pin-angle-fill text-warning"></i> ' : ''}
                                        ${thread.isLocked ? '<i class="bi bi-lock-fill text-danger"></i> ' : ''}
                                        <span></span>
                                    </h5>
                                    <p class="text-muted small">
                                        Created by <span id="thread-creator-${thread.threadId}"></span> 
                                        on ${new Date(thread.createdAt).toLocaleDateString()}
                                    </p>
                                </div>
                                <div class="text-muted small">
                                    Last post: ${new Date(thread.lastPostAt).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                $('#threadsContainer').append(threadHtml);
                
                // Safely set text content to prevent XSS
                $(`#thread-title-${thread.threadId} span`).text(thread.title);
                $(`#thread-creator-${thread.threadId}`).text(thread.creatorUserId);
            });
        }

        // Show create thread modal
        function showCreateThreadModal() {
            $('#newThreadTitle').val('');
            $('#createThreadModal').modal('show');
        }

        // Create new thread
        function createThread() {
            const title = $('#newThreadTitle').val().trim();
            
            if (!title) {
                alert('Please enter a thread title');
                return;
            }

            $.ajax({
                url: '/api/v1/threads',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    title: title
                }),
                success: function() {
                    $('#createThreadModal').modal('hide');
                    loadThreads();
                },
                error: commonFunctionError
            });
        }

        // Load messages for a thread
        function loadMessages(threadId) {
            currentThreadId = threadId;
            
            $('#threadListView').hide();
            $('#messageView').show();
            $('#messagesContainer').html('<div class="text-center"><div class="spinner-border" role="status"></div></div>');
            
            $.ajax({
                url: '/api/v1/messages',
                type: 'GET',
                contentType: 'application/json',
                data: JSON.stringify({
                    threadId: threadId
                }),
                success: function(response) {
                    displayMessages(response);
                },
                error: commonFunctionError
            });
        }

        // Display messages
        function displayMessages(messages) {
            $('#messagesContainer').empty();
            
            // Set up thread header (you might want to get this from the thread data)
            $('#threadHeader').html(`
                <h3>Thread Messages</h3>
                <div class="btn-group mb-3">
                    <button class="btn btn-sm btn-warning" onclick="toggleThreadLock()">
                        <i class="bi bi-lock"></i> Toggle Lock
                    </button>
                    <button class="btn btn-sm btn-info" onclick="toggleThreadPin()">
                        <i class="bi bi-pin-angle"></i> Toggle Pin
                    </button>
                </div>
            `);
            
            // Display message form
            $('#messageFormContainer').html(`
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Post a Message</h5>
                        <div class="mb-3">
                            <textarea class="form-control" id="newMessageContent" rows="3" 
                                      placeholder="Enter your message..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="postMessage()">
                            <i class="bi bi-send"></i> Post Message
                        </button>
                    </div>
                </div>
            `);
            
            if (!messages || messages.length === 0) {
                $('#messagesContainer').html('<div class="alert alert-info">No messages in this thread yet. Be the first to post!</div>');
                return;
            }

            messages.forEach(function(message) {
                let messageHtml = `
                    <div class="card message-item mb-3" id="message-${message.messageId}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-subtitle mb-2 text-muted">
                                        <span id="message-user-${message.messageId}"></span>
                                    </h6>
                                    <p class="card-text" id="message-content-${message.messageId}"></p>
                                    ${message.editedAt ? `<p class="edited-message">Edited: ${new Date(message.editedAt).toLocaleString()}</p>` : ''}
                                    <div class="message-metadata">
                                        Posted: ${new Date(message.createdAt).toLocaleString()}
                                    </div>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="showEditMessageModal(${message.messageId})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteMessage(${message.messageId})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                $('#messagesContainer').append(messageHtml);
                
                // Safely set text content
                $(`#message-user-${message.messageId}`).text(message.userId);
                $(`#message-content-${message.messageId}`).text(message.content);
            });
        }

        // Post new message
        function postMessage() {
            const content = $('#newMessageContent').val().trim();
            
            if (!content) {
                alert('Please enter a message');
                return;
            }

            $.ajax({
                url: '/api/v1/messages',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    threadId: currentThreadId,
                    content: content
                }),
                success: function() {
                    $('#newMessageContent').val('');
                    loadMessages(currentThreadId);
                },
                error: commonFunctionError
            });
        }

        // Show edit message modal
        function showEditMessageModal(messageId) {
            currentMessageId = messageId;
            const currentContent = $(`#message-content-${messageId}`).text();
            $('#editMessageContent').val(currentContent);
            $('#editMessageModal').modal('show');
        }

        // Save edited message
        function saveEditedMessage() {
            const content = $('#editMessageContent').val().trim();
            
            if (!content) {
                alert('Message content cannot be empty');
                return;
            }

            $.ajax({
                url: '/api/v1/messages',
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    messageId: currentMessageId,
                    content: content
                }),
                success: function() {
                    $('#editMessageModal').modal('hide');
                    loadMessages(currentThreadId);
                },
                error: commonFunctionError
            });
        }

        // Delete message
        function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) {
                return;
            }

            $.ajax({
                url: '/api/v1/messages',
                type: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({
                    messageId: messageId
                }),
                success: function() {
                    loadMessages(currentThreadId);
                },
                error: commonFunctionError
            });
        }

        // Toggle thread lock
        function toggleThreadLock() {
            $.ajax({
                url: '/api/v1/threads/lock',
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    threadId: currentThreadId,
                    isLocked: true // You might want to get current state first
                }),
                success: function() {
                    alert('Thread lock status updated');
                },
                error: commonFunctionError
            });
        }

        // Toggle thread pin
        function toggleThreadPin() {
            $.ajax({
                url: '/api/v1/threads/pin',
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    threadId: currentThreadId,
                    isPinned: true // You might want to get current state first
                }),
                success: function() {
                    alert('Thread pin status updated');
                },
                error: commonFunctionError
            });
        }

        // Go back to thread list
        function backToThreads() {
            $('#messageView').hide();
            $('#threadListView').show();
            loadThreads();
        }
    </script>
</body>
</html>